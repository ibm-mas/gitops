
{{- if .Values.sm_aws_access_key_id }}
---
kind: Secret
apiVersion: v1
metadata:
  name: aws
  namespace: mas-{{ .Values.mas_instance_id }}-core
  annotations:
    argocd.argoproj.io/sync-wave: "-4"
stringData:
  aws_access_key_id: {{ .Values.sm_aws_access_key_id }}
  aws_secret_access_key: {{ .Values.sm_aws_secret_access_key }}
  aws_default_region: {{ .Values.sm_aws_region }}
type: Opaque
{{- end }}

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: presync-sa
  namespace: mas-{{ .Values.mas_instance_id }}-core
  annotations:
    argocd.argoproj.io/sync-wave: "-4"
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: presync-sa
  namespace: mas-{{ .Values.mas_instance_id }}-core
  annotations:
    argocd.argoproj.io/sync-wave: "-4"
subjects:
  - kind: ServiceAccount
    name: presync-sa
    namespace: mas-{{ .Values.mas_instance_id }}-core
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin

---
# Permit outbound communication by the Job pods
# (Needed to communicate with the K8S HTTP API and AWS SM)
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: efs-presync-role-network-policy
  namespace: mas-{{ .Values.mas_instance_id }}-core
  annotations:
    argocd.argoproj.io/sync-wave: "-4"
spec:
  podSelector:
    matchLabels:
      app: "efs-presync-role"
  egress:
    - {}
  policyTypes:
    - Egress
