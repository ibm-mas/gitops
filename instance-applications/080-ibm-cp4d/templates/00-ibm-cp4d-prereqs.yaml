---
kind: ServiceAccount
apiVersion: v1
metadata:
  name: presync-cpd-prereq-sa
  namespace: "{{ .Values.cpd_operators_namespace }}"
  annotations:
    argocd.argoproj.io/sync-wave: "081"
{{- if .Values.custom_labels }}
  labels:
{{ .Values.custom_labels | toYaml | indent 4 }}
{{- end }}

---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: presync-cpd-prereq-role
  annotations:
    argocd.argoproj.io/sync-wave: "081"
{{- if .Values.custom_labels }}
  labels:
{{ .Values.custom_labels | toYaml | indent 4 }}
{{- end }}
rules:
  - verbs:
      - create
      - delete
      - get
      - list
      - patch
      - scale
      - update
      - watch
    apiGroups:
      - "*"
    resources:
      - "*"

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: presync-cpd-prereq-rb
  annotations:
    argocd.argoproj.io/sync-wave: "082"
{{- if .Values.custom_labels }}
  labels:
{{ .Values.custom_labels | toYaml | indent 4 }}
{{- end }}
subjects:
  - kind: ServiceAccount
    name: presync-cpd-prereq-sa
    namespace: "{{ .Values.cpd_operators_namespace }}"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: presync-cpd-prereq-role


---
apiVersion: batch/v1
kind: Job
metadata:
  name: "cpd-prereq-{{ .Values | toYaml | adler32sum }}"
  namespace: "{{ .Values.cpd_operators_namespace }}"
  annotations:
    argocd.argoproj.io/sync-wave: "083"
{{- if .Values.custom_labels }}
  labels:
{{ .Values.custom_labels | toYaml | indent 4 }}
{{- end }}
spec:
  template:
{{- if .Values.custom_labels }}
    metadata:
      labels:
{{ .Values.custom_labels | toYaml | indent 8 }}
{{- end }}
    spec:
      containers:
        - name: run
          image: quay.io/ibmmas/cli:9.0.0-pre.gitops
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              cpu: 200m
              memory: 512Mi
            requests:
              cpu: 10m
              memory: 64Mi
          env:
            - name: CPD_OPERATORS_NAMESPACE
              value: {{ .Values.cpd_operators_namespace }}
            - name: CPFS_CHANNEL
              value: {{ .Values.cpfs_channel }}
            - name: CPD_PLATFORM_CHANNEL
              value: {{ .Values.cpd_platform_channel }}
          command:
            - /bin/sh
            - -c
            - |

              set -e
              
              export CPFS_NAMESPACE=ibm-common-services
              # - Scale down ibm-common-service-operator, operand-deployment-lifecycle-manager and ibm-zen-operator deployments from ibm-common-services namespace (will be recreated when CPFS/ODLM v4 is installed)
              # - Delete common-service operandconfig and operandregistry (will be recreated when ODLM v4 is installed)
              # - Delete all namespace scope instances from ibm-common-services namespace (will be recreated when NamespaceScope v4 is installed)
              
              echo "scale down ibm-common-service operator and others if exists in ibm-common-services namespace"

              DEP1=$(oc get deployment ibm-common-service-operator -n ${CPFS_NAMESPACE})
              if [[ $DEP1 != *"not found"* && $DEP1 != *"Error"* ]]; then
                oc scale deployment ibm-common-service-operator -n ${CPFS_NAMESPACE} --replicas=0
              fi

              DEP2=$(oc get deployment operand-deployment-lifecycle-manager -n ${CPFS_NAMESPACE})
              if [[ $DEP2 != *"not found"* && $DEP2 != *"Error"* ]]; then
                oc scale deployment operand-deployment-lifecycle-manager -n ${CPFS_NAMESPACE} --replicas=0
              fi

              DEP3=$(oc get deployment ibm-zen-operator -n ${CPFS_NAMESPACE})
              if [[ $DEP3 != *"not found"* && $DEP3 != *"Error"* ]]; then
                oc scale deployment ibm-zen-operator -n ${CPFS_NAMESPACE} --replicas=0
              fi

              oc delete operandregistry -n ${CPFS_NAMESPACE} --ignore-not-found common-service
              oc delete operandconfig -n ${CPFS_NAMESPACE} --ignore-not-found common-service

              oc delete namespacescopes.operator.ibm.com nss-managedby-odlm -n ${CPFS_NAMESPACE} --ignore-not-found
              oc delete namespacescopes.operator.ibm.com odlm-scope-managedby-odlm -n ${CPFS_NAMESPACE} --ignore-not-found
              oc delete namespacescopes.operator.ibm.com nss-odlm-scope -n ${CPFS_NAMESPACE} --ignore-not-found
              oc delete namespacescopes.operator.ibm.com common-service -n ${CPFS_NAMESPACE} --ignore-not-found

              compare_channels(){
                CH1=$(echo "$1" | tr -d '.')
                CH2=$(echo "$2" | tr -d '.')
                echo $(( $CH1 - $CH2 ))
              }

              export CPFS_AVAILABLE_CHANNEL=$((oc get PackageManifest ibm-common-service-operator -o json) | jq -r '[.status.channels | .[].name] | last | split ("v") | last')
              if [[ ! -z "${CPFS_AVAILABLE_CHANNEL}" ]]; then
                COMPARE=$(compare_channels ${CPFS_AVAILABLE_CHANNEL} ${CPFS_CHANNEL:1})
                echo "Existing CPFS channel ............................. ${CPFS_AVAILABLE_CHANNEL}"
                echo "Expected CPFS channel ............................. ${CPFS_CHANNEL}"
                if [[ ${COMPARE} -ge 0 ]]; then
                  # Backup and Delete existing common-service-maps configmap
                  CSM_NAME=$((oc get ConfigMap common-service-maps -n kube-public --ignore-not-found -o json) | jq -r '.metadata.name')

                  if [[ ! -z $CSM_NAME ]]; then
                    BK_CM=$CSM_NAME-bkp-$(date +"%Y-%m-%d-%H-%M-%S")
                    echo "Creating backup config map ${BK_CM}"
                    BK_OUTPUT=$(oc patch cm common-service-maps -n kube-public -p "{\"metadata\":{ \"name\":\"$BK_CM\" }}" --dry-run=client -o yaml | oc apply -f -)
                    
                    if [[ $BK_OUTPUT == *"created"* ]]; then
                      oc delete ConfigMap common-service-maps -n kube-public
                    fi
                  fi


                  # Clean up old ibm-common-service and cpd-platform operators
                  echo "clean up old ibm-common-service and cpd-platform operators"
                  OP1=$(oc get Subscription --selector="operators.coreos.com/cpd-platform-operator.${CPD_OPERATORS_NAMESPACE}" -n ${CPD_OPERATORS_NAMESPACE} --ignore-not-found -ojsonpath='{.items[0].spec.channel}')
                  OP2=$(oc get Subscription --selector="operators.coreos.com/ibm-common-service-operator.${CPD_OPERATORS_NAMESPACE}" -n ${CPD_OPERATORS_NAMESPACE} --ignore-not-found -ojsonpath='{.items[0].spec.channel}')
                  if [[ ! -z $OP1 ]]; then
                    COMP1=$(compare_channels ${OP1:1} ${CPD_PLATFORM_CHANNEL:1})
                    if [[ $COMP1 != 0 ]]; then
                      oc delete Subscription --selector="operators.coreos.com/cpd-platform-operator.${CPD_OPERATORS_NAMESPACE}" -n ${CPD_OPERATORS_NAMESPACE} --ignore-not-found
                      oc delete ClusterServiceVersion --selector="operators.coreos.com/cpd-platform-operator.${CPD_OPERATORS_NAMESPACE}" -n ${CPD_OPERATORS_NAMESPACE} --ignore-not-found
                    fi
                  fi

                  if [[ ! -z $OP2 ]]; then
                    COMP2=$(compare_channels ${OP2:1} ${CPFS_CHANNEL:1})
                    if [[ $COMP2 != 0 ]]; then
                      oc delete Subscription --selector="operators.coreos.com/ibm-common-service-operator.${CPD_OPERATORS_NAMESPACE}" -n ${CPD_OPERATORS_NAMESPACE} --ignore-not-found
                      oc delete ClusterServiceVersion --selector="operators.coreos.com/ibm-common-service-operator.${CPD_OPERATORS_NAMESPACE}" -n ${CPD_OPERATORS_NAMESPACE} --ignore-not-found
                    fi
                  fi

                fi
              fi

      restartPolicy: Never
      serviceAccountName: presync-cpd-prereq-sa
  backoffLimit: 4
