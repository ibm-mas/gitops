---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: installplan-approver
  namespace: {{ .Values.odh_namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "123"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: installplan-approver
  namespace: {{ .Values.odh_namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "124"
rules:
  - apiGroups: ["operators.coreos.com"]
    resources: ["installplans"]
    verbs: ["get", "list", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: installplan-approver
  namespace: {{ .Values.odh_namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "125"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: installplan-approver
subjects:
  - kind: ServiceAccount
    name: installplan-approver
    namespace: {{ .Values.odh_namespace }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: installplanpatch-{{ .Values.odh_operator_version }}
  namespace: {{ .Values.odh_namespace }}
  annotations:
    argocd.argoproj.io/sync-wave: "127"
spec:
  template:
    spec:
      serviceAccountName: installplan-approver
      containers:
        - name: installplanjob
          image: quay.io/ibmmas/cli:latest
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              cpu: 200m
              memory: 512Mi
            requests:
              cpu: 10m
              memory: 64Mi
          env:
            - name: ODH_NAMESPACE
              value: "{{ .Values.odh_namespace }}"
            - name: ODH_VERSION
              value: "{{ .Values.odh_operator_version }}"
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for InstallPlans to be created..."
              sleep 60

              for i in $(seq 1 20); do
                IP=$(oc get installplan -n "${ODH_NAMESPACE}" -o json \
                  | jq -r --arg ODH_VERSION "$ODH_VERSION" '.items[] | select(.spec.clusterServiceVersionNames[] == $ODH_VERSION) | .metadata.name')
                
                if [ "$IP" ]; then
                  echo "Approving InstallPlan for ODH: $IP"
                  oc patch installplan $IP -n ${ODH_NAMESPACE} --type merge --patch '{"spec":{"approved":true}}'
                  break
                fi
                echo "InstallPlan not found. Retry $i..."
                sleep 15
              done
      restartPolicy: OnFailure