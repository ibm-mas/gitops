---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: installplan-approver
  namespace: openshift-operators
  annotations:
    argocd.argoproj.io/sync-wave: "123"
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: installplan-approver
  namespace: openshift-operators
  annotations:
    argocd.argoproj.io/sync-wave: "124"
rules:
  - apiGroups: ["operators.coreos.com"]
    resources: ["installplans"]
    verbs: ["get", "list", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: installplan-approver
  namespace: openshift-operators
  annotations:
    argocd.argoproj.io/sync-wave: "125"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: installplan-approver
subjects:
  - kind: ServiceAccount
    name: installplan-approver
    namespace: openshift-operators
---
apiVersion: batch/v1
kind: Job
metadata:
  name: installplanpatch
  namespace: openshift-operators
  annotations:
    argocd.argoproj.io/sync-wave: "126"
spec:
  template:
    spec:
      serviceAccountName: installplan-approver
      containers:
        - name: installplanjob
          image: quay.io/ibmmas/cli:latest
          imagePullPolicy: IfNotPresent
          resources:
            limits:
              cpu: 200m
              memory: 512Mi
            requests:
              cpu: 10m
              memory: 64Mi
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for InstallPlans to be created..."
              sleep 60

              for i in $(seq 1 20); do
                IP=$(oc get installplan -n openshift-operators -o json   | jq -r '.items[] | select(.spec.clusterServiceVersionNames[] == "opendatahub-operator.v2.11.1") | .metadata.name')
                if [ "$IP" ]; then
                  echo "Approving InstallPlan for ODH: $IP"
                  oc patch installplan $IP -n "openshift-operators" --type merge --patch '{"spec":{"approved":true}}'
                  break
                fi
                echo "InstallPlan not found. Retry $i..."
                sleep 15
              done
      restartPolicy: OnFailure