---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: copy-secret-job
  namespace: {{ .Values.aiservice_namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-reader
  namespace: {{ .Values.aiservice_namespace }}
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-reader-binding
  namespace: {{ .Values.aiservice_namespace }}
subjects:
  - kind: ServiceAccount
    name: copy-secret-job
    namespace: {{ .Values.aiservice_namespace }}
roleRef:
  kind: Role
  name: secret-reader
  apiGroup: rbac.authorization.k8s.io

# apiVersion: v1
# kind: Secret
# metadata:
#   name: ibm-entitlement
#   namespace: "{{ .Values.tenantNamespace }}"
#   labels:
#     app.kubernetes.io/managed-by: gitops
#   annotations:
#     argocd.argoproj.io/sync-wave: "305"
# type: Opaque
# data:
#   {{- with (lookup "v1" "Secret" .Values.ibm_aiservice_tenant.aiservice_namespace "ibm-entitlement") }}
#   {{- range $k, $v := .data }}
#   {{ $k }}: {{ $v }}
#   {{- end }}
#   {{- end }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: copy-ibm-entitlement
  namespace: {{ .Values.aiservice_namespace }}
  annotations:
    argocd.argoproj.io/hook: PreSync
spec:
  template:
    spec:
      serviceAccountName: copy-secret-job
      containers:
        - name: copy-secret
          image: bitnami/kubectl:latest
          command:
            - /bin/sh
            - -c
            - |
              echo "Copying ibm-entitlement secret from {{ .Values.aiservice_namespace }} to {{ .Values.tenantNamespace }}"
              kubectl get secret ibm-entitlement -n {{ .Values.aiservice_namespace }} -o yaml | \
              sed "s/namespace: {{ .Values.aiservice_namespace }}/namespace: {{ .Values.tenantNamespace }}/" | \
              kubectl apply -f -
      restartPolicy: OnFailure


# ---
# apiVersion: v1
# kind: Secret
# metadata:
#   name: km-s3-secret
#   namespace: "{{ .Values.tenantNamespace }}"
#   labels:
#     app.kubernetes.io/managed-by: gitops
#   annotations:
#     {{- with (lookup "v1" "Secret" (printf "aiservice-%s" .Values.aiservice_instance_id) "km-s3-secret") }}
#     {{- if .metadata.annotations }}
#     {{- range $k, $v := .metadata.annotations }}
#     {{- if ne $k "argocd.argoproj.io/sync-wave" }}
#     {{ $k }}: {{ $v | quote }}
#     {{- end }}
#     {{- end }}
#     {{- end }}
#     {{- end }}
#     argocd.argoproj.io/sync-wave: "306"
# type: Opaque
# data:
#   {{- with (lookup "v1" "Secret" .Values.ibm_aiservice_tenant.aiservice_namespace "km-s3-secret") }}
#   {{- range $k, $v := .data }}
#   {{ $k }}: {{ $v }}
#   {{- end }}
#   {{- end }}

