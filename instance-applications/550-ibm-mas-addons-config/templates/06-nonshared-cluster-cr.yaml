# This file creates a marker ConfigMap for each instance and manages the GenericAddon resource
# Note: This file will only be processed when nonshared=true at the cluster level
# When nonshared=false, the entire Application won't be created

---
# Create a marker ConfigMap to track that this instance exists
apiVersion: v1
kind: ConfigMap
metadata:
  name: "nonshared-marker-{{ .Values.instance_id }}"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "555"
  labels:
    mas.ibm.com/instanceId: {{ .Values.instance_id }}
    mas.ibm.com/nonsharedMarker: "true"
data:
  instance_id: "{{ .Values.instance_id }}"
  provisioned_at: "{{ now | date "2006-01-02T15:04:05Z07:00" }}"

---
# The GenericAddon resource - shared among all instances
apiVersion: addons.mas.ibm.com/v1
kind: GenericAddon
metadata:
  name: "cluster-addons-nonsharedcluster"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "556"
    # Prevent deletion when an instance is deprovisioned
    argocd.argoproj.io/sync-options: Prune=false,Delete=false,Replace=false,ApplyOnly=true
    argocd.argoproj.io/compare-options: IgnoreExtraneous
  labels:
    mas.ibm.com/configScope: system
    mas.ibm.com/clusterResource: "true"
    mas.ibm.com/sharedResource: "true"
{{- if .Values.custom_labels }}
{{ .Values.custom_labels | toYaml | indent 4 }}
{{- end }}
spec:
  displayName: "nonsharedcluster"
  addonType: nonsharedcluster
  config:
    instances:
      - name: "nonsharedcluster"
