{{- /* Only proceed if nonshared is true */ -}}
{{- if .Values.nonshared }}

{{- /* Create a central registry ConfigMap to track which instance owns the GenericAddon */ -}}
{{- $registryCM := (lookup "v1" "ConfigMap" "openshift-gitops" "nonshared-registry") -}}
{{- $ownerInstance := "" -}}
{{- $isOwner := false -}}

{{- /* Determine the current owner or if we need to become the owner */ -}}
{{- if $registryCM -}}
  {{- if hasKey $registryCM.data "owner_instance" -}}
    {{- $ownerInstance = $registryCM.data.owner_instance -}}
    
    {{- /* Check if the owner instance still exists */ -}}
    {{- $ownerExists := false -}}
    {{- $ownerNamespace := printf "mas-%s-core" $ownerInstance -}}
    {{- $namespaces := (lookup "v1" "Namespace" "" $ownerNamespace) -}}
    {{- if $namespaces -}}
      {{- $ownerExists = true -}}
    {{- end -}}
    
    {{- if not $ownerExists -}}
      {{- /* Previous owner is gone, we'll take ownership */ -}}
      {{- $ownerInstance = .Values.instance_id -}}
      {{- $isOwner = true -}}
    {{- else if eq $ownerInstance .Values.instance_id -}}
      {{- /* We are already the owner */ -}}
      {{- $isOwner = true -}}
    {{- end -}}
  {{- else -}}
    {{- /* No owner defined yet, we'll take ownership */ -}}
    {{- $ownerInstance = .Values.instance_id -}}
    {{- $isOwner = true -}}
  {{- end -}}
{{- else -}}
  {{- /* Registry doesn't exist, we'll create it and take ownership */ -}}
  {{- $ownerInstance = .Values.instance_id -}}
  {{- $isOwner = true -}}
{{- end -}}

---
# Create or update the registry ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: "nonshared-registry"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "554"
  labels:
    mas.ibm.com/nonsharedRegistry: "true"
data:
  owner_instance: "{{ $ownerInstance }}"
  last_updated: "{{ now | date "2006-01-02T15:04:05Z07:00" }}"

{{- /* Only create the GenericAddon if we are the owner */ -}}
{{- if $isOwner }}
---
# The shared GenericAddon resource - only created by the owner instance
apiVersion: addons.mas.ibm.com/v1
kind: GenericAddon
metadata:
  name: "cluster-addons-nonsharedcluster"
  namespace: mas-{{ .Values.instance_id }}-core
  annotations:
    argocd.argoproj.io/sync-wave: "556"
    argocd.argoproj.io/sync-options: Prune=false
    argocd.argoproj.io/compare-options: IgnoreExtraneous
  labels:
    mas.ibm.com/configScope: system
    mas.ibm.com/clusterResource: "true"
    mas.ibm.com/sharedResource: "true"
    mas.ibm.com/ownerInstance: "{{ .Values.instance_id }}"
    mas.ibm.com/instanceId: "{{ .Values.instance_id }}"  # Adding this label to fix the error
{{- if .Values.custom_labels }}
{{ .Values.custom_labels | toYaml | indent 4 }}
{{- end }}
spec:
  displayName: "nonsharedcluster"
  addonType: nonsharedcluster
  config:
    instances:
      - name: "nonsharedcluster"

---
# Add debug information to help troubleshoot
apiVersion: v1
kind: ConfigMap
metadata:
  name: "nonshared-debug-{{ .Values.instance_id }}"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "557"
data:
  instance_id: "{{ .Values.instance_id }}"
  is_owner: "true"
  owner_instance: "{{ $ownerInstance }}"
  nonshared_value: "{{ .Values.nonshared }}"
  timestamp: "{{ now | date "2006-01-02T15:04:05Z07:00" }}"
{{- end }}

{{- else }}
{{- /* If nonshared is false, we need to clean up the registry and GenericAddon */ -}}

{{- /* Check if we are the current owner */ -}}
{{- $registryCM := (lookup "v1" "ConfigMap" "openshift-gitops" "nonshared-registry") -}}
{{- $isOwner := false -}}
{{- if $registryCM -}}
  {{- if hasKey $registryCM.data "owner_instance" -}}
    {{- if eq $registryCM.data.owner_instance .Values.instance_id -}}
      {{- $isOwner = true -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* If we are the owner, delete the GenericAddon and registry */ -}}
{{- if $isOwner }}
---
# Delete the registry since nonshared=false
apiVersion: v1
kind: ConfigMap
metadata:
  name: "nonshared-registry"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "555"
    argocd.argoproj.io/hook: "Sync"
    argocd.argoproj.io/hook-delete-policy: "BeforeHookCreation"

---
# Delete the GenericAddon since nonshared=false
apiVersion: addons.mas.ibm.com/v1
kind: GenericAddon
metadata:
  name: "cluster-addons-nonsharedcluster"
  namespace: mas-{{ .Values.instance_id }}-core
  annotations:
    argocd.argoproj.io/sync-wave: "556"
    argocd.argoproj.io/hook: "Sync"
    argocd.argoproj.io/hook-delete-policy: "BeforeHookCreation"

---
# Add debug information to help troubleshoot
apiVersion: v1
kind: ConfigMap
metadata:
  name: "nonshared-debug-{{ .Values.instance_id }}"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "557"
data:
  instance_id: "{{ .Values.instance_id }}"
  is_owner: "true"
  nonshared_value: "{{ .Values.nonshared }}"
  timestamp: "{{ now | date "2006-01-02T15:04:05Z07:00" }}"
  action: "cleanup"
{{- end }}

{{- end }}

