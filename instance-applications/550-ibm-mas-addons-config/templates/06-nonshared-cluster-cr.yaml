{{- if .Values.nonshared }}
---
# Create a marker ConfigMap to track that this instance has contributed to the shared resource
apiVersion: v1
kind: ConfigMap
metadata:
  name: "nonshared-marker-{{ .Values.instance_id }}"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "555"
  labels:
    mas.ibm.com/instanceId: {{ .Values.instance_id }}
    mas.ibm.com/nonsharedMarker: "true"
data:
  instance_id: "{{ .Values.instance_id }}"
  provisioned_at: "{{ now | date "2006-01-02T15:04:05Z07:00" }}"
---
# The shared GenericAddon resource
# Note: The app.kubernetes.io/instance label will toggle between instances during syncs.
# This is expected behavior and doesn't affect functionality.
apiVersion: addons.mas.ibm.com/v1
kind: GenericAddon
metadata:
  name: "cluster-addons-nonsharedcluster"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "556"
    # Strong annotations to prevent ArgoCD from modifying the resource
    argocd.argoproj.io/sync-options: Prune=false,Delete=false,Replace=false,ApplyOnly=true
    argocd.argoproj.io/compare-options: IgnoreExtraneous
    # This annotation tells ArgoCD this is a resource that should be skipped during sync
    argocd.argoproj.io/resource-customizations: |
      addons.mas.ibm.com/GenericAddon:
        health.lua: |
          return { status = "Healthy", message = "GenericAddon is managed outside of normal sync" }
  labels:
    mas.ibm.com/configScope: system
    mas.ibm.com/clusterResource: "true"
    # This label indicates this is a shared cluster resource
    mas.ibm.com/sharedResource: "true"
{{- if .Values.custom_labels }}
{{ .Values.custom_labels | toYaml | indent 4 }}
{{- end }}
spec:
  displayName: "NonsharedCluster"
  addonType: nonsharedcluster
  config:
    instances:
      - name: "NonsharedCluster"
---
# Job to create the GenericAddon if it doesn't exist
apiVersion: batch/v1
kind: Job
metadata:
  name: "nonshared-ensure-{{ .Values.instance_id }}"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "557"
    argocd.argoproj.io/hook: "Sync"
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
  labels:
    mas.ibm.com/instanceId: {{ .Values.instance_id }}
spec:
  template:
    spec:
      serviceAccountName: default
      containers:
      - name: ensure
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          echo "Starting ensure job for instance {{ .Values.instance_id }}"
          
          # Check if the GenericAddon exists
          if ! oc get genericaddon cluster-addons-nonsharedcluster -n openshift-gitops &>/dev/null; then
            echo "GenericAddon does not exist. Creating it..."
            cat <<EOF | oc apply -f -
          apiVersion: addons.mas.ibm.com/v1
          kind: GenericAddon
          metadata:
            name: "cluster-addons-nonsharedcluster"
            namespace: openshift-gitops
            annotations:
              argocd.argoproj.io/sync-options: Prune=false,Delete=false,Replace=false,ApplyOnly=true
              argocd.argoproj.io/compare-options: IgnoreExtraneous
            labels:
              mas.ibm.com/configScope: system
              mas.ibm.com/clusterResource: "true"
              mas.ibm.com/sharedResource: "true"
              app.kubernetes.io/managed-by: "mas-gitops"
          spec:
            displayName: "NonsharedCluster"
            addonType: nonsharedcluster
            config:
              instances:
                - name: "NonsharedCluster"
          EOF
            echo "GenericAddon created."
          else
            echo "GenericAddon already exists. No action needed."
          fi
      restartPolicy: Never
  backoffLimit: 3
---
# Job to check if the GenericAddon should be deleted when nonshared instances are gone
apiVersion: batch/v1
kind: Job
metadata:
  name: "nonshared-cleanup-check-{{ .Values.instance_id }}"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "558"
    argocd.argoproj.io/hook: "Sync"
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
  labels:
    mas.ibm.com/instanceId: {{ .Values.instance_id }}
spec:
  template:
    spec:
      serviceAccountName: default
      containers:
      - name: cleanup-check
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          echo "Starting cleanup check for instance {{ .Values.instance_id }}"
          
          # Check if there are any marker ConfigMaps other than this instance's
          OTHER_MARKERS=$(oc get configmap -n openshift-gitops -l mas.ibm.com/nonsharedMarker=true --no-headers | grep -v nonshared-marker-{{ .Values.instance_id }} | wc -l)
          
          echo "Found $OTHER_MARKERS other instances using the GenericAddon"
          
          # No action needed - the GenericAddon will be managed by the ensure job
          # and will be deleted by the disable-cleanup job when nonshared=false
      restartPolicy: Never
  backoffLimit: 3
{{- else }}
---
# Job to clean up resources when nonshared is set to false
apiVersion: batch/v1
kind: Job
metadata:
  name: "nonshared-disable-cleanup-{{ .Values.instance_id }}"
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "555"
    argocd.argoproj.io/hook: "Sync"
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
  labels:
    mas.ibm.com/instanceId: {{ .Values.instance_id }}
spec:
  template:
    spec:
      serviceAccountName: default
      containers:
      - name: cleanup
        image: registry.redhat.io/openshift4/ose-cli:latest
        command:
        - /bin/bash
        - -c
        - |
          echo "Starting cleanup for nonshared=false"
          
          # Delete the marker ConfigMap for this instance
          oc delete configmap nonshared-marker-{{ .Values.instance_id }} -n openshift-gitops --ignore-not-found
          
          # Check if there are any other instances using this resource
          MARKER_COUNT=$(oc get configmap -n openshift-gitops -l mas.ibm.com/nonsharedMarker=true --no-headers | wc -l)
          
          if [ "$MARKER_COUNT" -eq "0" ]; then
            echo "No other instances found using the nonshared cluster resource. Deleting the GenericAddon."
            # Delete the GenericAddon
            oc delete genericaddon cluster-addons-nonsharedcluster -n openshift-gitops --ignore-not-found
            
            echo "GenericAddon deleted."
          else
            echo "Found $MARKER_COUNT other instances still using the nonshared cluster resource. Keeping the GenericAddon."
          fi
      restartPolicy: Never
  backoffLimit: 3
{{- end }}