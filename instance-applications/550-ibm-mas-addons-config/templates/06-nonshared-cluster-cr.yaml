{{- /* Only proceed if nonshared is true */ -}}
{{- if .Values.nonshared }}

{{- /* Use a deterministic approach to select an owner - the instance with the lexicographically smallest ID */ -}}
{{- $allNamespaces := (lookup "v1" "Namespace" "" "") -}}
{{- $instanceNamespaces := list -}}

{{- /* Find all MAS instance namespaces */ -}}
{{- range $namespace := $allNamespaces.items -}}
  {{- if hasPrefix "mas-" $namespace.metadata.name -}}
    {{- if hasSuffix "-core" $namespace.metadata.name -}}
      {{- $instanceId := trimSuffix "-core" (trimPrefix "mas-" $namespace.metadata.name) -}}
      {{- $instanceNamespaces = append $instanceNamespaces $instanceId -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Sort the instance IDs lexicographically */ -}}
{{- $sortedInstances := $instanceNamespaces | sortAlpha -}}
{{- $ownerInstance := "" -}}
{{- $isOwner := false -}}

{{- /* The first instance in the sorted list is the owner */ -}}
{{- if $sortedInstances -}}
  {{- $ownerInstance = index $sortedInstances 0 -}}
  {{- if eq $ownerInstance .Values.instance_id -}}
    {{- $isOwner = true -}}
  {{- end -}}
{{- end -}}

{{- /* Only create the GenericAddon if we are the owner */ -}}
{{- if $isOwner }}
---
# The shared GenericAddon resource - only created by the owner instance
apiVersion: addons.mas.ibm.com/v1
kind: GenericAddon
metadata:
  name: "cluster-addons-nonsharedcluster"
  namespace: mas-{{ .Values.instance_id }}-core
  annotations:
    argocd.argoproj.io/sync-wave: "556"
    argocd.argoproj.io/sync-options: Prune=false
    argocd.argoproj.io/compare-options: IgnoreExtraneous
  labels:
    mas.ibm.com/configScope: system
    mas.ibm.com/clusterResource: "true"
    mas.ibm.com/sharedResource: "true"
    mas.ibm.com/ownerInstance: "{{ .Values.instance_id }}"
    mas.ibm.com/instanceId: "{{ .Values.instance_id }}"  # Adding this label to fix the error
{{- if .Values.custom_labels }}
{{ .Values.custom_labels | toYaml | indent 4 }}
{{- end }}
spec:
  displayName: "nonsharedcluster"
  addonType: nonsharedcluster
  config:
    instances:
      - name: "nonsharedcluster"
{{- end }}

{{- else }}
{{- /* If nonshared is false, we need to clean up the GenericAddon */ -}}

{{- /* Use the same deterministic approach to find the owner */ -}}
{{- $allNamespaces := (lookup "v1" "Namespace" "" "") -}}
{{- $instanceNamespaces := list -}}

{{- /* Find all MAS instance namespaces */ -}}
{{- range $namespace := $allNamespaces.items -}}
  {{- if hasPrefix "mas-" $namespace.metadata.name -}}
    {{- if hasSuffix "-core" $namespace.metadata.name -}}
      {{- $instanceId := trimSuffix "-core" (trimPrefix "mas-" $namespace.metadata.name) -}}
      {{- $instanceNamespaces = append $instanceNamespaces $instanceId -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Sort the instance IDs lexicographically */ -}}
{{- $sortedInstances := $instanceNamespaces | sortAlpha -}}
{{- $ownerInstance := "" -}}
{{- $isOwner := false -}}

{{- /* The first instance in the sorted list is the owner */ -}}
{{- if $sortedInstances -}}
  {{- $ownerInstance = index $sortedInstances 0 -}}
  {{- if eq $ownerInstance .Values.instance_id -}}
    {{- $isOwner = true -}}
  {{- end -}}
{{- end -}}

{{- /* Only delete the GenericAddon if we are the owner */ -}}
{{- if $isOwner }}
---
# Delete the GenericAddon since nonshared=false
apiVersion: addons.mas.ibm.com/v1
kind: GenericAddon
metadata:
  name: "cluster-addons-nonsharedcluster"
  namespace: mas-{{ .Values.instance_id }}-core
  annotations:
    argocd.argoproj.io/sync-wave: "556"
    argocd.argoproj.io/hook: "Sync"
    argocd.argoproj.io/hook-delete-policy: "BeforeHookCreation"
{{- end }}

{{- end }}

# Made with Bob
