<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://pages.github.com/ibm-mas/gitops/orchestration/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Deployment Orchestration - MAS GitOps</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../extra.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Deployment Orchestration";
        var mkdocs_page_input_path = "orchestration.md";
        var mkdocs_page_url = "/ibm-mas/gitops/orchestration/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> MAS GitOps
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../helmcharts/">Helm Charts</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../configrepo/">Config Repository</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../accountrootmanifest/">Account Root Application Manifest</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../configtoinstances/">Generated Applications</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Deployment Orchestration</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#automated-sync-policies">Automated Sync Policies</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sync-waves">Sync Waves</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sync-waves_1">Sync Waves</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#custom-resource-healthchecks">Custom resource healthchecks</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../reference/">Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../limitations/">Known Limitations</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">MAS GitOps</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Deployment Orchestration</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/ibm-mas/gitops/blob/demo2/docs/orchestration.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="deployment-orchestration">Deployment Orchestration<a class="headerlink" href="#deployment-orchestration" title="Permanent link"></a></h1>
<p>The MAS GitOps Helm Charts have been developed with the aim of simplifying the orchestration of MAS deployments (i.e. ensuring tasks and resources are applied in the proper sequence) as much as possible.</p>
<p>Once a <strong>Target Cluster</strong> has been provisioned and registered with the ArgoCD instance running in the <strong>Management Cluster</strong>, MAS instances can be deployed and managed on that <strong>Target Cluster</strong> solely by registering secrets in the <strong>Secrets Vault</strong> and pushing configuration files to the <strong>Config Repo</strong>.</p>
<ul>
<li>There is no need to run any commands against ArgoCD or the <strong>Target Cluster</strong> to initiate or control synchronization.</li>
<li>To stand up MAS instances, all configuration files for a MAS cluster and its instances can be pushed at once to the <strong>Config Repo</strong> in a single commit .</li>
<li>To deprovision MAS instances, all configuration files for the instance can be deleted at once from the <strong>Config Repo</strong> in a single commit.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For automated deprovisioning of MAS instances to work as intended, ArgoCD version 2.11.0 or greater must be used. This is due to a <a href="https://github.com/argoproj/argo-cd/issues/15074">known issue</a> in older versions of ArgoCD where resources were not being correctly pruned in reverse syncwave order. </p>
</div>
<p>This is achieved using a combination of the following ArgoCD mechanisms:</p>
<ul>
<li><a href="https://argo-cd.readthedocs.io/en/stable/user-guide/auto_sync/#automated-sync-policy">Automated Sync Policies</a></li>
<li><a href="https://argo-cd.readthedocs.io/en/stable/user-guide/sync-waves/">Sync Waves</a></li>
<li><a href="https://argo-cd.readthedocs.io/en/stable/user-guide/resource_hooks/">Resource Hooks</a> that perform various tasks at the appropriate time</li>
<li><a href="https://argo-cd.readthedocs.io/en/stable/operator-manual/health/#custom-health-checks">Custom resource healthchecks</a></li>
</ul>
<h2 id="automated-sync-policies">Automated Sync Policies<a class="headerlink" href="#automated-sync-policies" title="Permanent link"></a></h2>
<p>All Applications defined in the MAS GitOps have the following sync policy defined:</p>
<pre><code class="language-yaml">syncPolicy:
  automated:
    selfHeal: true
    prune: true
</code></pre>
<p>The ArgoCD Application Set git generators will automatically pick up configuration files pushed the the <strong>Config Repo</strong>. The resulting Applications will then be sychronized automatically due to the sync policy above. In addition:</p>
<ul>
<li><code>selfHeal: true</code> will make ArgoCD undo any changes made manually to any cluster resources that it is managing. This ensures that proper...</li>
<li><code>prune: true</code> </li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>We may make <code>prune</code> configurable on a per-account basis in future releases. <code>prune: true</code> is useful in development systems as it allows MAS instances to be deprovisioned with no manual intervention. This may be too risky for use in production systems though and <code>prune: false</code> may be necessary; meaning a request must be made to ArgoCD after configuration files are deleted to explicitly perform a sync with pruning enabled.</p>
</div>
<h2 id="sync-waves">Sync Waves<a class="headerlink" href="#sync-waves" title="Permanent link"></a></h2>
<h2 id="sync-waves_1">Sync Waves<a class="headerlink" href="#sync-waves_1" title="Permanent link"></a></h2>
<h2 id="custom-resource-healthchecks">Custom resource healthchecks<a class="headerlink" href="#custom-resource-healthchecks" title="Permanent link"></a></h2>
<p>This has been achieved using the ArgoCD [sync wave] mechanism combined with </p>
<p>No connectivity is required</p>
<p>Once ArgoCD is installed and configured on the <strong>Management Cluster</strong></p>
<ul>
<li>All configuration files for a MAS instance can be pushed to the <strong>Config Repo</strong> at the same time and ArgoCD will ensure that resources are created in <strong>Target Clusters</strong> in the correct order.</li>
<li>No connectivity is required between </li>
</ul>
<p>To ensure that we sync resources in the correct order they are annotated with an  For clarity, we also prefix all resource filenames with the sync wave that they belong to. Note that sync waves are <em>local</em> to each ArgoCD application (i.e. each Helm chart).</p>
<blockquote>
<p>TODO: document the various use of ArgoCD hooks for creating secrets / running scripts / etc.</p>
<p>TODO: we often don't use post-sync hooks - instead we use normal jobs that run last. These jobs often perform pre-requisite steps for subsequent sync waves (e.g. setting up secrets in the <strong>Secrets Vault</strong>) and having them as "normal" jobs ensures that ArgoCD will wait for their completion before allowing Applications in subsequent syncwaves to proceed.</p>
<p>TODO: Document custom health checks, in particular the Application healthcheck required for the App of Apps pattern to work:  https://argo-cd.readthedocs.io/en/stable/operator-manual/health/#argocd-app</p>
</blockquote>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/ibm-mas/gitops" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../configtoinstances/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../reference/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
      <script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
